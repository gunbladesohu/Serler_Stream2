<h1>User Role Management</h1>
<div id="mainTable"></div>

<script  type="text/javascript">
     $(document).ready(function () {
         
             var dataSource = new kendo.data.DataSource({
                             transport: {
                                     read:  {
                                        url: "/admin/getUserList",
                                        dataType: "json"
                                    },
                                     create:  {
                                        url: "/admin/addNewUser",
                                        dataType: "json",
                                        type: "POST"
                                    },
                                     update:  {
                                         url: function(e) {
                                            var selectedRolesId = multi._old;
                                             var userId = e.id;
                                             
                                             return "/admin/updateUser?userId=" + userId + "&selectedRolesId=" + selectedRolesId;
                                            
                                        },
                                        dataType: "json",
                                        type: "POST",
                                        complete: function(e) {
                                			grid.dataSource.read(); 
                                		}
                                    },
                                    destroy: {
                                        url: function(e) {
                                            return "/users/" + e.id;
                                        },
                                        dataType: "json",
                                        type: "DELETE"
                                    }
                                    ,
                                    parameterMap: function(options, operation) {
                                        if (operation !== "read" && options.models) {
                                            return {models: kendo.stringify(options.models)};
                                        }
                                    }
                                },
                                pageSize: 20
                                ,
                            schema: {
                                model: {
                                    id: "id",
                                    fields: {
                                        id: {editable: false, nullable: false },
                                          first_name: {type: "string", editable: false, nullable: false },
                                        middle_name: {type: "string", editable: false, nullable: true },
                                        last_name: {type: "string", editable: false, nullable: false },
                                        gender: {type: "string", editable: false, nullable: false },
                                        dob: {type: "date", editable: false, nullable: false },
                                        email: {type: "string", editable: false, nullable: false },
                                        password_digest: {type: "string", editable: false, nullable: false },
                                        role_name: {type: "string", editable: true, nullable: false }
                                    }
                                }
                            }
                        });
                        
       var grid =  $("#mainTable").kendoGrid({
                    dataSource: dataSource,
                    height: 550,
                    sortable: true,
                    resizable: true,
                    pageable: {
                        refresh: true,
                        pageSizes: true,
                        buttonCount: 5
                    },
                    columns: [
                    { field: "first_name", title: "First Name" }, 
                    { field: "middle_name", title: "Middle Name", hidden: true }, 
                    { field: "last_name", title: "Last Name" }, 
                    { field: "email", title: "Email" }, 
                    { field: "gender", title: "Gender" , hidden: true , editor: genderDropDownEditor}, 
                    { field: "dob", title: "Date of birth" , hidden: true},
                    { field: "password_digest", title: "Password" , hidden: true,
                        editor: function (container, options) {
                            $('<input data-text-field="' + options.field + '" ' +
                                    'class="k-input k-textbox" ' +
                                    'type="password" ' + 'placeholder="At least 6 characters and 1 number" ' +
                                    'data-value-field="' + options.field + '" ' +
                                    'data-bind="value:' + options.field + '"/>')
                                    .appendTo(container)
                        }
                    },
                    { field: "role_name", title: "User Roles", editor: rolesMultiSelect , width: "250px"},
                    { command: ["edit"], title: "&nbsp;", width: "250px" }]
                     ,editable: {
                         mode: "inline", 
                         confirmation: "Are you sure that you want to delete this user?"
                     }
                }).data("kendoGrid");
                
                var genderData = [
                        { text: "Male", value: "Male" },
                        { text: "Female", value: "Female" }
                    ];
                var multi;    
                 function genderDropDownEditor(container, options) {
                     
                    var dropdown = $('<input required name="' + options.field + '"/>')
                        .appendTo(container)
                        .kendoDropDownList({
                            autoBind: true,
                            dataTextField: "text",
                            dataValueField: "value",
                            dataSource: genderData
                        }).data("kendoDropDownList");
                        
                }
                
                function rolesMultiSelect(container, options) {
                    
                    var Roles = options.model.role_name;
                    var roleSource = new kendo.data.DataSource({
                        serverFiltering: true,
                             transport: {
                                     read:  {
                                        url: "/admin/getRoles",
                                        dataType: "json"
                                    }
                                }
                        });
                        
                    multi = $('<input name="' + options.field + '"/>')
                        .appendTo(container)
                        .kendoMultiSelect({
                            dataTextField: "name",
                            dataValueField: "id",
                            autoBind: false,
                            dataSource: roleSource
                        }).data("kendoMultiSelect");
                        
                        var array =[];
                         roleSource.fetch(function() {
                          var view = roleSource.view();
                          
                          
                          $.each( view, function( key, value ) {
                              if(value.name != "User"){
                                  var roleValues = value.name;
                                  if(Roles.indexOf(roleValues) >= 0){
                                      array.push(value.id.toString());
                                  }
                              }
                            });
                         
                          multi.value(array);
                        });
                }
     });
    
            
</script>