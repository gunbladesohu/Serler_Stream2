<p id="notice"><%= notice %></p>

<h1>Search Result</h1>

<br>
<div class="container">
<div class="row">
  <div class="col-lg-12">
    <div class="row table_box">
      <div class="col-md-6">
        <form action="/search_queries" class="search-form" method="get">
          <div class="input-group">
            <%= text_field_tag 'quick_search', params[:quick_search], placeholder: 'Quick search by title...', class: 'form-control' %>
            <!--<input id="quick_search" type="text" placeholder="Quick search by title" name="search" class="form-control">-->
            <span class="input-group-btn" required>
              <button id="quick_go" type="submit" class="btn btn-primary"> Go!</button>
            </span>
          </div>
          <p class="mandatory">* This field is required!!</p>
          <%= link_to 'Advance Search', new_search_query_path, {class: 'btn btn-success'} %>
        </form>
      </div>
      <div class="col-md-6">
        <div class="column-view">
          <label style="font-weight:bold;">Filter: </label>
          <label><input type="checkbox" class="check-head" value="1" name="author"><span>Author</span></label>
          <label><input type="checkbox" class="check-head" value="1" name="year" checked="checked"><span>Year</span></label>
          <label><input type="checkbox" class="check-head" value="1" name="journal"><span>Journal</span></label>
          <label><input type="checkbox" class="check-head" value="1" name="volume"><span>Volume</span></label>
          <label><input type="checkbox" class="check-head" value="1" name="issues"><span>Issues</span></label>
          <label><input type="checkbox" class="check-head" value="1" name="pages"><span>Pages</span></label>
          <label><input type="checkbox" class="check-head" value="1" name="doi"><span>DOI</span></label>
          <label><input type="checkbox" class="check-head" value="1" name="url"><span>URL</span></label>
          <label><input type="checkbox" class="check-head" value="1" name="keywords"><span>Keywords</span></label>
          <label><input type="checkbox" class="check-head" value="1" name="methodology"><span>Methodology</span></label>
          <label><input type="checkbox" class="check-head" value="1" name="method"><span>Method</span></label>
          <label><input type="checkbox" class="check-head" value="1" name="research_method"><span>Research Method</span></label>
          <label><input type="checkbox" class="check-head" value="1" name="participant"><span>Participant</span></label>
        </div>
      </div>
    </div>
    
    <% if @search_query != nil %>
      <h4>Search from
        <% if @search_query.from_date > 0 %> 
          <%= @search_query.from_date %>
        <% else %>
          past
        <% end %> 
        to <%= @search_query.to_date %></h4>
      <p>
        <% @search_query.search_lines.each_with_index do |search_line, index| %>
          <% if index > 0 %>
            <span class="label label-info"><%= search_line.join_condition_txt %></span>
          <% end %>
          <%= search_line.search_field_txt %> <%= search_line.opertator_txt %> <%= search_line.value %>
        <% end %>
      </p>
      <% if @search_query.allow_save == true %>

        <button type="button" class="btn btn-success toggle-model" id="sv_qr" data-toggle="modal">
          Save Query
        </button>
        <% if @search_result != nil %>
          <button type="button" class="btn btn-primary toggle-model-result" id="sv_rs" data-toggle="modal">
            Save Result
          </button>
        <% end %>

      <% else %>
        <button type="button" class="btn btn-primary toggle-model" data-toggle="modal">
          Update Description
        </button>
      <% end %>

      <!-- Save query modal -->
      <div class="modal fade" id="save_query" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
              <h4 class="modal-title">Save Query</h4>
            </div>
            <div class="modal-body">
              <%= form_for(@search_query) do |f| %>
                <div class="form-group">
                  <%= f.label :description %><br>
                  <%= f.text_field :description, class: "form-control" %>
                  <p class="mandatory1">This field is required</p>
                </div>
                <%= f.hidden_field :isActive, {value: 'true'} %>
                <%= f.submit :'Save', {class: 'btn btn-success'} %>
              <% end %>
            </div>
          </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
      </div><!-- /.modal -->

      <% if @search_result != nil %>
      <!-- Save result modal -->
        <div class="modal fade" id="save_result" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
          <div class="modal-dialog" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">Save Results</h4>
              </div>
              <div class="modal-body">
                  <%= form_tag({controller: "search_queries", action: "update_result"}, method: "post") do %>
                  <%= label_tag(:description, "Description:") %>
                  <%= text_field_tag 'description' %>
                  <%= hidden_field_tag :isActive, true %>
                  <%= hidden_field_tag :id, @search_result.id %>

                  <%= submit_tag("Save Result") %>
                  <% end %>
                <%#= form_for @search_result, :url => {:action => 'update_result'} do |f| %>
                    <!-- <div class="form-group"> -->
                      <%#= f.label :description %><!-- <br> -->
                      <%#= f.text_field :description, class: "form-control" %>
                      <!-- <p class="mandatory1">This field is required</p> -->
                    <!-- </div> -->
                    <%#= f.hidden_field :isActive, {value: 'true'} %>
                    <%#= f.submit :'Save', {class: 'btn btn-success'} %>
                <%# end %>
              </div>
            </div><!-- /.modal-content -->
          </div><!-- /.modal-dialog -->
        </div><!-- /.modal -->
        <% end %> 
    <% end %> 


    <div class="table-responsive">
      <table class="table table-striped" id="result-table">
        <thead>
        <tr>
          <th id="col0" class="title">Title <span class="grey"><i class="fa fa-sort"></i></span></th>
          <th id="col1" class="author">Author <span class="grey"><i class="fa fa-sort"></i></span></th>
          <th id="col2" class="year">Year <span class="grey"><i class="fa fa-sort"></i></span></th>
          <th id="col3" class="journal">Journal <span class="grey"><i class="fa fa-sort"></i></span></th>
          <th id="col4" class="volume">Volume <span class="grey"><i class="fa fa-sort"></i></span></th>
          <th id="col5" class="issues">Issues <span class="grey"><i class="fa fa-sort"></i></span></th>
          <th id="col6" class="pages">Pages <span class="grey"><i class="fa fa-sort"></i></span></th>
          <th id="col7" class="doi">DOI <span class="grey"><i class="fa fa-sort"></i></span></th>
          <th id="col8" class="url">URL <span class="grey"><i class="fa facd-sort"></i></span></th>
          <th id="col9" class="keywords">Keywords <span class="grey"><i class="fa fa-sort"></i></span></th>
          <th id="col10" class="methodology">Methodologies <span class="grey"><i class="fa fa-sort"></i></span></th>
          <th id="col11" class="method">Methods <span class="grey"><i class="fa fa-sort"></i></span></th>
          <th id="col12" class="research_method">Research Methods <span class="grey"><i class="fa fa-sort"></i></span></th>
          <th id="col13" class="participant">Participants <span class="grey"><i class="fa fa-sort"></i></span></th>
        </tr>
        </thead>
        <tbody>
        <% @articles.each do |article| %> 
          <tr>
            <td class="title"><a href="<%= article.url %>" target= "_blank" class="tooltips" title="<%= article.title %>"><div class="table_result_title"><%= article.title %></div></a></td>
            <td class="author"><%= article.articles_authors.map { |articles_author| articles_author.author.full_name}.join(', ') %></td>
            <td class="year"><%= article.year %></td>
            <td class="journal"><%= article.journal %></td>
            <td class="volume"><%= article.volume %></td>
            <td class="issues"><%= article.number %></td>
            <td class="pages"><%= article.pages %></td>
            <td class="doi"><%= article.doi %></td>
            <td class="url"><%= article.url %></td>
            <td class="keywords"><%= article.keyword %></td>
            <td class="methodology"><%= article.articles_methodologies.map { |articles_methodology| articles_methodology.methodology.name}.join(', ') %>  </td>
            <td class="method"><%= article.articles_dev_methods.map { |articles_dev_method| articles_dev_method.dev_method.name}.join(', ') %></td>
            <td class="research_method"><%= article.articles_research_methods.map { |articles_research_method| articles_research_method.research_method.name}.join(', ') %></td>
            <td class="participant"><%= article.articles_research_participants.map { |articles_research_participant| articles_research_participant.research_participant.name}.join(', ') %></td>
          </tr>

        <% end %>
        </tbody>
      </table>

    </div>
  </div>
</div>
</div>
<script type="text/javascript">
  $(document).ready(function(){

    $(".tooltips").tooltip({placement: 'top'});

    $(".toggle-model").click(function () {
      $('#save_query').modal('toggle');
    });

    $(".toggle-model-result").click(function () {
      $('#save_result').modal('toggle');
    });


    $(".check-head:checkbox:not(:checked)").each(function(){
      var col = "table ." + $(this).attr("name");
      $(col).hide();
    });

    $(".check-head:checkbox").click(function(){
      var col = "table ." + $(this).attr("name");
      $(col).toggle();
    });

    var table = $('#result-table').DataTable({
      paging: false,
      retrieve: true,
      dom: '<"bottom">p'
    });

    $('#result-table').on('order.dt', function () {
      var order = table.order();
      var col = order[0][0];
      var orderType = order[0][1];
      var span = $('#col' + col).find('#result-table span'); // selected span
      var i = $('#col' + col).find('i'); // selected i
      $('#result-table span').attr('class', 'grey'); // set all span to grey
      $('#result-table thead i').attr('class', 'fa fa-sort'); // reset all sort icon
      span.attr('class', 'orange'); // set selected span to orange
      i.attr('class', 'fa fa-sort-' + orderType);
    });

    $(".search-form").submit(function(e) {
      if($.trim($('#quick_search').val()) == ''){
        $("#quick_search").css("border", "2px solid red");
        $(".mandatory").css("display", "block");
        e.preventDefault();
        return false;
      }
    });


    $(".edit_search_query").submit(function(e) {
      if($.trim($('#search_query_description').val()) == ''){
        $("#search_query_description").css("border", "2px solid red");
        $(".mandatory1").css("display", "block");
        e.preventDefault();
        return false;
      }
    });


//    $("#result-table").colResizable({
//      liveDrag:true,
//      gripInnerHtml:"<div class='grip'></div>",
//      draggingClass:"dragging" });

//    $('td').each(function(){
//      $(this).text($(this).text().substring(0,38)+"...");
//    });

    $(function() {
      var pressed = false;
      var start = undefined;
      var startX, startWidth;

      $("table th").mousedown(function(e) {
        start = $(this);
        pressed = true;
        startX = e.pageX;
        startWidth = $(this).width();
        $(start).addClass("resizing");
      });

      $(document).mousemove(function(e) {
        if(pressed) {
          $(start).width(startWidth+(e.pageX-startX));
        }
      });

      $(document).mouseup(function() {
        if(pressed) {
          $(start).removeClass("resizing");
          pressed = false;
        }
      });
    });




  });
</script>
